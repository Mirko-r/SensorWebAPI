<!DOCTYPE html>
<html>
<head>
<title>Docu.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/*
Date: 24 Fev 2015
Author: Pedro Oliveira <kanytu@gmail . com>
*/

.hljs {
  color: #a9b7c6;
  background: #282b2e;
  display: block;
  overflow-x: auto;
  padding: 0.5em;
}

.hljs-number,
.hljs-literal,
.hljs-symbol,
.hljs-bullet {
  color: #6897BB;
}

.hljs-keyword,
.hljs-selector-tag,
.hljs-deletion {
  color: #cc7832;
}

.hljs-variable,
.hljs-template-variable,
.hljs-link {
  color: #629755;
}

.hljs-comment,
.hljs-quote {
  color: #808080;
}

.hljs-meta {
  color: #bbb529;
}

.hljs-string,
.hljs-attribute,
.hljs-addition {
  color: #6A8759;
}

.hljs-section,
.hljs-title,
.hljs-type {
  color: #ffc66d;
}

.hljs-name,
.hljs-selector-id,
.hljs-selector-class {
  color: #e8bf6a;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="esercitazione-finale">Esercitazione finale</h1>
<h2 id="1-introduzione">1. Introduzione</h2>
<h3 id="11-scenario">1.1 Scenario</h3>
<p><img src="./Scrh/case_study.png" alt="scenario"></p>
<h3 id="12-tech-stack">1.2 Tech Stack</h3>
<ul>
<li><strong>.NET:</strong> Utilizzato per lo sviluppo delle applicazioni console e del servizio web.</li>
<li><strong>RabbitMQ:</strong> Broker di messaggi per la gestione delle code.</li>
<li><strong>Entity Framework Core:</strong> ORM per l'accesso al database.</li>
<li><strong>ASP.NET Core:</strong> Framework per lo sviluppo del servizio web API.</li>
<li><strong>React:</strong> Libreria JavaScript per lo sviluppo della dashboard SPA.</li>
<li><strong>JWT (JSON Web Token):</strong> Utilizzato per l'autenticazione nelle API.</li>
<li><strong>Swagger:</strong> Utilizzato per documentare il servizio web ASP.NET Core.</li>
<li><strong>Postman:</strong> Utilizzato per testare gli endpoint del servizio web.</li>
</ul>
<h3 id="13-ruolo-di-rabbitmq">1.3 Ruolo di RabbitMq</h3>
<p>Il broker di messaggi RabbitMQ è utilizzato per garantire una comunicazione asincrona tra le macchine produttive e il sistema di raccolta dati. Ogni macchina invia i dati di produzione ad una coda nel broker, e poi i messaggi verranno letti in modo asincrono.</p>
<h3 id="14-mvc-desing-pattern">1.4 MVC Desing Pattern</h3>
<p>Il design pattern Model-View-Controller (MVC) è utilizzato nella progettazione e implementazione del servizio web ASP.NET Core. Questo pattern divide l'applicazione in tre componenti principali:</p>
<ul>
<li><strong>Modello:</strong> rappresenta i dati e la logica di business.</li>
<li><strong>Vista:</strong> gestisce l'interfaccia utente.</li>
<li><strong>Controller:</strong> gestisce le interazioni tra la Vista e il Modello.</li>
</ul>
<h3 id="15-autenticazioneautorizzazione-jwt">1.5 Autenticazione/Autorizzazione JWT</h3>
<ul>
<li><strong>Autenticazione:</strong> è il processo di verifica dell'identità dell'utente  per proteggere risorse sensibili e garantire che solo gli utenti autorizzati possano accedervi.</li>
<li><strong>Autorizzazione:</strong> Determina quali azioni può eseguire l'utente autenticato, il sistema deve determinare quali azioni o risorse l'utente è autorizzato a utilizzare. Ad esempio, un utente può avere il permesso di leggere dati ma non di modificarli, o può avere l'accesso solo a determinate parti di un'applicazione.</li>
</ul>
<h3 id="151-jwt">1.5.1 Jwt</h3>
<p>Un JSON Web Token (JWT) è composto da tre parti: Header, Payload e Signature (Firma). Ognuna di queste parti è codificata in Base64URL e concatenate con un punto (&quot;.&quot;). Il risultato finale è una stringa che rappresenta il token completo.</p>
<ul>
<li><strong>Header:</strong> contiene informazioni sull'alogoritmo utilizzato per la firma del token</li>
<li><strong>Payload:</strong> contiene le informazioni utili del token. Le informazioni sono chiamate Claims e possono includere dati sull'utente, autorizzazioni, scadenza del token, roles, audience e issuer.</li>
<li><strong>Signature:</strong> è il risultato della firma digitale dell'Header e del Payload combinati con una chiave segreta.</li>
</ul>
<h2 id="2-sql">2. SQL</h2>
<pre class="hljs"><code><div><span class="hljs-comment">-- Creating the Machines table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> Machines (
    machineid <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) PRIMARY <span class="hljs-keyword">KEY</span>,
    location <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);

<span class="hljs-comment">-- Creating the Productions table</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> Productions (
    productionid <span class="hljs-built_in">INT</span> PRIMARY <span class="hljs-keyword">KEY</span>,
    machineid <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">REFERENCES</span> Machines(machineid),
    <span class="hljs-keyword">year</span> <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">month</span> <span class="hljs-built_in">INT</span>,
    <span class="hljs-keyword">day</span> <span class="hljs-built_in">INT</span>,
    hourofday <span class="hljs-built_in">INT</span> <span class="hljs-keyword">CHECK</span> (hourofday &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> hourofday &lt;= <span class="hljs-number">24</span>),
    make <span class="hljs-built_in">int</span>
);

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">Users</span>(
    UserId <span class="hljs-built_in">bigint</span> <span class="hljs-keyword">identity</span>,
    Username <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>),
    <span class="hljs-keyword">Password</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">500</span>),
    <span class="hljs-keyword">Role</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">500</span>),  
    HashToVerify <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>),
    SaltToVerify <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>)
)

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> Machines (machineid, location) 
<span class="hljs-keyword">values</span>
(<span class="hljs-string">'LSD23431OP'</span>, <span class="hljs-string">'Milan'</span>),
(<span class="hljs-string">'LLOPRER13P'</span>, <span class="hljs-string">'Rome'</span>)
</div></code></pre>
<h2 id="3-implementazione-di-jwt">3. Implementazione di JWT</h2>
<h3 id="configurazione-in-programcs">Configurazione in Program.cs</h3>
<pre class="hljs"><code><div>builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme) <span class="hljs-comment">// JWT auth</span>
    .AddJwtBearer(options =&gt;
    {
        options.TokenValidationParameters = <span class="hljs-keyword">new</span> TokenValidationParameters
        {
            ValidateIssuer = <span class="hljs-literal">true</span>, <span class="hljs-comment">// chi ha rilasciato il token</span>
            ValidateAudience = <span class="hljs-literal">true</span>, <span class="hljs-comment">// portatore del token</span>
            ValidateLifetime = <span class="hljs-literal">true</span>, <span class="hljs-comment">// scadenza del token</span>
            ValidateIssuerSigningKey = <span class="hljs-literal">true</span>, <span class="hljs-comment">// validare chiave che ha firmato il token</span>
            ValidIssuer = builder.Configuration[<span class="hljs-string">"Jwt:Issuer"</span>], <span class="hljs-comment">// chi è l'issuer?</span>
            ValidAudience = builder.Configuration[<span class="hljs-string">"Jwt:Audience"</span>], <span class="hljs-comment">// chi è l'audience</span>
            IssuerSigningKey = <span class="hljs-keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(
                builder.Configuration[<span class="hljs-string">"Jwt:Key"</span>])
            ) <span class="hljs-comment">//chiave per firmare il token</span>
        };
    });
</div></code></pre>
<h3 id="processo-di-autenticazione-nel-controller">Processo di autenticazione nel Controller</h3>
<h4 id="1-post-del-login">1. Post del login</h4>
<pre class="hljs"><code><div> [<span class="hljs-meta">HttpPost(<span class="hljs-meta-string">"login"</span>)</span>]
 [<span class="hljs-meta">AllowAnonymous</span>] <span class="hljs-comment">// non c'è bisogno di presentare un token</span>
 [<span class="hljs-meta">ProducesResponseType(StatusCodes.Status200OK)</span>]
 [<span class="hljs-meta">ProducesResponseType(StatusCodes.Status401Unauthorized)</span>]
 <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">Login</span>(<span class="hljs-params">[FromBody] UserModel login</span>)</span>
 {
     Console.WriteLine(<span class="hljs-string">"ss"</span>);
     IActionResult response = Unauthorized(); <span class="hljs-comment">// 401</span>
     <span class="hljs-keyword">var</span> user = AuthenticateUser(login);
     <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>)
     {
         Console.WriteLine(<span class="hljs-string">"user not null"</span>);
         <span class="hljs-keyword">string</span> tokenString = GenerateJSONWebToken(user);
         response = Ok(<span class="hljs-keyword">new</span> { token = tokenString });
     }
     <span class="hljs-keyword">return</span> response;
 } 
</div></code></pre>
<h4 id="2-authenticatuser">2. AuthenticatUser</h4>
<pre class="hljs"><code><div> <span class="hljs-function"><span class="hljs-keyword">private</span> User <span class="hljs-title">AuthenticateUser</span>(<span class="hljs-params">UserModel login</span>)</span>
{
    <span class="hljs-keyword">try</span>
    {
        User user = _context.Users.FirstOrDefault(
            u =&gt; u.Username.Equals(login.Username)
            );
        <span class="hljs-keyword">if</span> (user.VerifyPassword(login.Password, user.HashToVerify, user.SaltToVerify))
        {
            <span class="hljs-keyword">return</span> user;
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Password not verified"</span>);
        }
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-comment">// Aggiungi la gestione dell'eccezione, ad esempio il logging</span>
        Console.WriteLine(<span class="hljs-string">$"Errore durante l'autenticazione: <span class="hljs-subst">{ex.Message}</span>"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
} 
</div></code></pre>
<p>Questo metodo controlla nel se l'utente esiste nel DB e verifica la password utilizzando una funzione di hash.</p>
<h4 id="3-generatejsonwebtoken">3. GenerateJSONWebTOken</h4>
<pre class="hljs"><code><div> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-title">GenerateJSONWebToken</span>(<span class="hljs-params">User login</span>)</span>
{
    <span class="hljs-keyword">var</span> securitykey = <span class="hljs-keyword">new</span> SymmetricSecurityKey(
        Encoding.UTF8.GetBytes(_config[<span class="hljs-string">"Jwt:Key"</span>])
        );

    <span class="hljs-keyword">var</span> claims = <span class="hljs-keyword">new</span>[] {
        <span class="hljs-keyword">new</span> Claim(JwtRegisteredClaimNames.Sub, login.Username),
        <span class="hljs-keyword">new</span> Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()), <span class="hljs-comment">// uid univoco del claim </span>
        <span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"role"</span>, login.Role.ToString())
    };

    <span class="hljs-keyword">var</span> token = <span class="hljs-keyword">new</span> JwtSecurityToken(
        _config[<span class="hljs-string">"Jwt:Issuer"</span>],
        _config[<span class="hljs-string">"Jwt:Audience"</span>],
        claims,
        expires: DateTime.Now.AddMinutes(<span class="hljs-number">120</span>),
        signingCredentials: <span class="hljs-keyword">new</span> SigningCredentials(
            securitykey, SecurityAlgorithms.HmacSha256)
        );

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtSecurityTokenHandler().WriteToken(token);
}
</div></code></pre>
<p>Genera il JWT per l'utente autenticato.</p>
<h2 id="4-consumatore">4. Consumatore</h2>
<h3 id="struttura-del-codice">Struttura del codice</h3>
<p>Il codice è diviso in due principali sezioni: la configurazione e l'utilizzo di RabbitMQ e l'utilizzo di ADO.NET per l'accesso e la manipolazione dei dati nel database SQL Server. La gestione del multithreading è implementata attraverso l'uso di Thread.Sleep per simulare l'attesa di un'ora prima dell'elaborazione dei dati.
RabbitMq creerà un'altro Thread  in ascolto di messaggi da una coda specificata.</p>
<h2 id="5-adonet--entity-framework">5. ADO.Net / Entity Framework</h2>
<ul>
<li><strong>ADO.Net:</strong> fornisce accesso diretto al DB, utilizzato nel Consumatore per avere un controllo più diretto sulla manipolazione dei dati e logica personalizzata nelle query</li>
<li><strong>Entity Framework:</strong> è un ORM (Object-Relational Mapping) che semplifica la gestione dei dati mediante l'astrazione dei dati del database in oggetti nel codice, utilizzato nella web API per semplificare l'accesso ai dati.</li>
</ul>
<h2 id="6-esempi-di-funzionamento-web-api-con-postman">6. Esempi di funzionamento web API con Postman</h2>
<h3 id="successful-login">Successful Login</h3>
<p><img src="./Scrh/Login_Example.png" alt="loginyes"></p>
<h3 id="chiamata-ad-un-web-api-method-senza-autorizzazione">Chiamata ad un Web API Method senza autorizzazione</h3>
<p><img src="./Scrh/Unhautorized_Example.png" alt="noauth"></p>
<h3 id="httpget-all-productions">HttpGet All Productions</h3>
<p><img src="./Scrh/Postman_get_all.png" alt="getall"></p>
<h3 id="httpget-by-machineid">HttpGet by MAchineID</h3>
<p><img src="./Scrh/Postman_get_by_MachineID.png" alt="getByMcId"></p>
<h3 id="httppost-a-production">HttpPost a Production</h3>
<p><img src="./Scrh/Postman_post_productions.png" alt="post"></p>
<h3 id="httpdelete-all-productions-with-a-machineid">HttpDelete all productions with a MachineId</h3>
<p><img src="./Scrh/Postman_delete_from_MachineId.png" alt="deleteAllWithMachineId"></p>

</body>
</html>
